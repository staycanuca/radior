<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio Professional Shoutcast</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }

        #nowPlaying {
            text-align: center;
            margin: 15px 0;
            padding: 10px;
            background: rgba(255,255,255,0.9);
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .radio-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            padding: 15px;
        }

        .radio-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .radio-card:hover {
            transform: translateX(5px);
        }

        .radio-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .radio-title {
            font-size: 1.1em;
            color: #2c3e50;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .play-btn, .stop-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
            flex-shrink: 0;
        }

        .play-btn:hover, .stop-btn:hover {
            background: #219a52;
        }

        .stop-btn {
            background: #e74c3c;
        }

        .stop-btn:hover {
            background: #c0392b;
        }

        #fileInput {
            display: block;
            margin: 20px auto;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #ddd;
            cursor: pointer;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Radio Professional Shoutcast</h1>
        <input type="file" id="fileInput" accept=".m3u">
        <div id="nowPlaying">üéµ Nu este √Æn curs de redare</div>
        <div class="radio-list" id="radioList">
            <!-- Post demo predefinit -->
            <div class="radio-card">
                <div class="radio-info">
                    <span class="radio-title">Radio Prob FM</span>
                    <button class="play-btn" data-url="http://live.radioprob.ro:8888/">‚ñ∂ Play</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CORS_PROXY = "https://cors-anywhere.herokuapp.com/";
        let currentSound = null;
        let metadataReader = null;
        let currentPlayingUrl = null;

        function stopCurrentStream() {
            if (currentSound) {
                currentSound.stop();
                currentSound = null;
            }
            if (metadataReader) {
                metadataReader.cancel();
                metadataReader = null;
            }
            currentPlayingUrl = null;
            updateButtons();
            document.getElementById('nowPlaying').textContent = "üéµ Nu este √Æn curs de redare";
        }

        async function playRadio(url) {
            if (currentPlayingUrl === url) {
                stopCurrentStream();
                return;
            }

            stopCurrentStream();
            currentPlayingUrl = url;

            try {
                // Folosim proxy CORS pentru a evita erorile
                const proxyUrl = CORS_PROXY + url;
                
                // ConfigurƒÉm redarea audio
                currentSound = new Howl({
                    src: [proxyUrl],
                    html5: true,
                    format: ['mp3', 'aac'],
                    onend: () => stopCurrentStream(),
                    onplayerror: () => handlePlayError(url)
                });

                currentSound.play();
                updateButtons();
                getStreamMetadata(url);
            } catch (error) {
                console.error('Eroare:', error);
                stopCurrentStream();
            }
        }

        async function getStreamMetadata(url) {
            try {
                const response = await fetch(CORS_PROXY + url, {
                    headers: {
                        'Icy-MetaData': '1',
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)'
                    }
                });
                
                const metaint = parseInt(response.headers.get('icy-metaint'));
                if (!metaint) return;

                metadataReader = response.body.getReader();
                let buffer = new Uint8Array();
                
                const processData = async ({ done, value }) => {
                    if (done) return;
                    
                    buffer = concatTypedArrays(buffer, value);
                    
                    while (buffer.length >= metaint) {
                        // SƒÉrim peste datele audio
                        buffer = buffer.slice(metaint);
                        
                        // Citim metadatele
                        const metadataLength = buffer[0] * 256;
                        buffer = buffer.slice(1);
                        
                        if (metadataLength > 0 && buffer.length >= metadataLength) {
                            const metadata = new TextDecoder().decode(buffer.slice(0, metadataLength));
                            const titleMatch = metadata.match(/StreamTitle='(.*?)';/);
                            if (titleMatch) {
                                document.getElementById('nowPlaying').textContent = 
                                    `üéµ √én curs de redare: ${titleMatch[1]}`;
                            }
                            buffer = buffer.slice(metadataLength);
                        }
                    }
                    
                    metadataReader.read().then(processData);
                };
                
                metadataReader.read().then(processData);
            } catch (error) {
                console.log('Nu pot prelua metadate:', error);
            }
        }

        function handlePlayError(url) {
            // √éncercƒÉm redarea directƒÉ ca fallback
            new Audio(url).play().catch(() => {
                stopCurrentStream();
                alert('Nu pot reda acest stream!');
            });
        }

        function concatTypedArrays(a, b) {
            const c = new Uint8Array(a.length + b.length);
            c.set(a, 0);
            c.set(b, a.length);
            return c;
        }

        function updateButtons() {
            document.querySelectorAll('.radio-card button').forEach(button => {
                const buttonUrl = button.dataset.url;
                if (buttonUrl === currentPlayingUrl) {
                    button.classList.add('stop-btn');
                    button.classList.remove('play-btn');
                    button.textContent = '‚èπ Stop';
                } else {
                    button.classList.add('play-btn');
                    button.classList.remove('stop-btn');
                    button.textContent = '‚ñ∂ Play';
                }
            });
        }

        function parseM3U(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const lines = e.target.result.split('\n');
                const stations = [];
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line.startsWith('#EXTINF')) {
                        const name = line.split(',')[1] || `Post ${stations.length + 1}`;
                        const url = lines[++i]?.trim();
                        if (url) stations.push({ name, url });
                    } else if (line.startsWith('http')) {
                        stations.push({
                            name: `Post ${stations.length + 1}`,
                            url: line
                        });
                    }
                }
                
                renderRadioStations(stations);
            };
            reader.readAsText(file);
        }

        function renderRadioStations(stations) {
            const radioList = document.getElementById('radioList');
            radioList.innerHTML = '';
            
            stations.forEach((station, index) => {
                const card = document.createElement('div');
                card.className = 'radio-card';
                card.innerHTML = `
                    <div class="radio-info">
                        <span class="radio-title">${index + 1}. ${station.name}</span>
                        <button class="play-btn" data-url="${station.url}">‚ñ∂ Play</button>
                    </div>
                `;
                radioList.appendChild(card);
            });
        }

        // Gestionare evenimente
        document.getElementById('radioList').addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button || !button.dataset.url) return;

            const url = button.dataset.url;
            url === currentPlayingUrl ? stopCurrentStream() : playRadio(url);
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) parseM3U(file);
        });
    </script>
</body>
</html>
